# æ‹ç…§åè¯†åˆ«çƒ­é‡ - å®Œæ•´ä»£ç æµç¨‹

## æ¦‚è¿°
æœ¬æ–‡æ¡£è¯´æ˜ä»æ‹ç…§åˆ°è¯†åˆ«çƒ­é‡çš„å®Œæ•´ä»£ç æ‰§è¡Œæµç¨‹ã€‚

---

## ğŸ“¸ æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»æ‹ç…§æŒ‰é’®
    â†“
æ‰“å¼€ç›¸æœºç•Œé¢ (CameraScreen)
    â†“
æ‹ç…§å®Œæˆï¼Œè¿”å›å›¾ç‰‡è·¯å¾„
    â†“
è°ƒç”¨ FoodProvider.recognizeFoodFromImage()
    â†“
è°ƒç”¨ ApiService.recognizeFood()
    â†“
å›¾ç‰‡è½¬ Base64 ç¼–ç 
    â†“
æ„å»º API è¯·æ±‚ï¼ˆåŒ…å«å›¾ç‰‡å’Œ Promptï¼‰
    â†“
å‘é€åˆ°è±†åŒ…å¤šæ¨¡æ€ API
    â†“
è§£æ JSON å“åº”
    â†“
è°ƒæ•´å’ŒéªŒè¯è¯†åˆ«ç»“æœ
    â†“
æ˜¾ç¤ºç»“æœé¡µé¢ (ResultScreen)
    â†“
ç”¨æˆ·ç¡®è®¤å¹¶ä¿å­˜åˆ°æ•°æ®åº“
```

---

## ğŸ” ä»£ç è¯¦è§£

### 1. æ‹ç…§å…¥å£ (`camera_home_screen.dart`)

**ä½ç½®**: [`lib/screens/camera_home_screen.dart:89-122`](file:///Users/zhb/code/food/lib/screens/camera_home_screen.dart#L89-L122)

```dart
// ç”¨æˆ·ç‚¹å‡»å¤§å‹åœ†å½¢ç›¸æœºæŒ‰é’®
void _takePhoto(BuildContext context) {
  // å¯¼èˆªåˆ°ç›¸æœºç•Œé¢ï¼Œä¼ å…¥å›è°ƒå‡½æ•°
  AppRoutes.navigateToCamera(context, (imagePath) {
    _processImage(context, imagePath);
  });
}

// å¤„ç†æ‹æ‘„çš„å›¾ç‰‡
Future<void> _processImage(BuildContext context, String imagePath) async {
  final foodProvider = Provider.of<FoodProvider>(context, listen: false);
  
  try {
    // 1. æ˜¾ç¤ºåŠ è½½å¯¹è¯æ¡†
    AppUtils.showLoadingDialog(context, 'æ­£åœ¨è¯†åˆ«é£Ÿç‰©...');
    
    // 2. è°ƒç”¨ Provider çš„è¯†åˆ«æ–¹æ³•
    final response = await foodProvider.recognizeFoodFromImage(imagePath);
    
    // 3. éšè—åŠ è½½å¯¹è¯æ¡†
    AppUtils.hideLoadingDialog(context);
    
    // 4. æ ¹æ®è¯†åˆ«ç»“æœå¯¼èˆª
    if (response.success && response.data != null) {
      // æˆåŠŸï¼šè·³è½¬åˆ°ç»“æœé¡µé¢
      AppRoutes.navigateToResult(context, {
        'analysis': response.data,
        'imagePath': imagePath,
      });
    } else {
      // å¤±è´¥ï¼šæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      AppUtils.showErrorSnackBar(context, response.message);
    }
  } catch (e) {
    AppUtils.hideLoadingDialog(context);
    AppUtils.showErrorSnackBar(context, 'è¯†åˆ«å¤±è´¥: $e');
  }
}
```

---

### 2. FoodProvider è¯†åˆ«é€»è¾‘ (`food_provider.dart`)

**ä½ç½®**: [`lib/providers/food_provider.dart:117-173`](file:///Users/zhb/code/food/lib/providers/food_provider.dart#L117-L173)

```dart
/// è¯†åˆ«é£Ÿç‰©å›¾ç‰‡
Future<ApiResponse> recognizeFoodFromImage(String imagePath) async {
  try {
    _clearError();
    _setLoading(true);
    
    debugPrint('å¼€å§‹è¯†åˆ«é£Ÿç‰©å›¾ç‰‡: $imagePath');
    
    // 1. è°ƒç”¨ API æœåŠ¡è¯†åˆ«
    final response = await _apiService.recognizeFood(imagePath);
    
    if (response.success && response.data != null) {
      // 2. éªŒè¯å’Œè°ƒæ•´è¯†åˆ«ç»“æœ
      final adjustedAnalysis = _adjustFoodAnalysis(response.data!);
      return ApiResponse.success(
        adjustedAnalysis, 
        rawResponse: response.rawResponse
      );
    }
    
    return response;
    
  } catch (e) {
    return ApiResponse.error('è¯†åˆ«å¤±è´¥: $e');
  } finally {
    _setLoading(false);
  }
}

/// è°ƒæ•´é£Ÿç‰©åˆ†æç»“æœï¼ˆéªŒè¯çƒ­é‡åˆç†æ€§ï¼‰
FoodAnalysis _adjustFoodAnalysis(FoodAnalysis analysis) {
  int adjustedCalories = analysis.calories;
  
  // å¦‚æœçƒ­é‡è¿‡ä½ï¼Œä½¿ç”¨çƒ­é‡è®¡ç®—å™¨é‡æ–°ä¼°ç®—
  if (analysis.calories < 20) {
    adjustedCalories = CalorieCalculator.estimateCaloriesByFoodName(
      analysis.foodName,
      weight: analysis.weight,
    );
  }
  
  // å¦‚æœä»ç„¶è¿‡ä½ï¼Œä½¿ç”¨æˆåˆ†ä¼°ç®—
  if (adjustedCalories < 20 && analysis.ingredients.isNotEmpty) {
    adjustedCalories = CalorieCalculator.calculateTotalCalories(
      analysis.ingredients,
      totalWeight: analysis.weight,
    );
  }
  
  // æ ¹æ®é¤æ¬¡è°ƒæ•´
  final mealTypeCalories = CalorieCalculator.adjustCaloriesByMealType(
    adjustedCalories,
    analysis.mealType,
  );
  
  return analysis.copyWith(
    calories: mealTypeCalories > 0 ? mealTypeCalories : adjustedCalories,
    confidence: _adjustConfidence(/* ... */),
  );
}
```

---

### 3. API æœåŠ¡æ ¸å¿ƒå®ç° (`api_service.dart`)

#### 3.1 é…ç½®ä¿¡æ¯

**ä½ç½®**: [`lib/services/api_service.dart:12-16`](file:///Users/zhb/code/food/lib/services/api_service.dart#L12-L16)

```dart
// APIé…ç½®ï¼ˆç¬¦åˆ PRD è¦æ±‚ï¼‰
static const String _baseUrl = 'https://ark.cn-beijing.volces.com/api/v3';
static const String _apiKey = '405fe7f2-f603-4c4c-b04b-bdea5d441319';
static const String _model = 'doubao-seed-1-6-vision-250815';
static const Duration _timeout = Duration(seconds: 30);
```

#### 3.2 ä¸»è¯†åˆ«æ–¹æ³•

**ä½ç½®**: [`lib/services/api_service.dart:57-99`](file:///Users/zhb/code/food/lib/services/api_service.dart#L57-L99)

```dart
Future<ApiResponse> recognizeFood(String imagePath) async {
  try {
    debugPrint('å¼€å§‹è¯†åˆ«é£Ÿç‰©: $imagePath');
    
    // 1. æ£€æŸ¥æ–‡ä»¶
    final file = File(imagePath);
    if (!await file.exists()) {
      return ApiResponse.error('å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨');
    }
    
    final fileSize = await file.length();
    if (fileSize > _maxFileSize) {
      return ApiResponse.error('å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„å›¾ç‰‡');
    }
    
    // 2. è½¬æ¢å›¾ç‰‡ä¸º Base64
    final base64Image = await _imageToBase64(imagePath);
    if (base64Image == null) {
      return ApiResponse.error('å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒ');
    }
    
    // 3. æ„å»ºè¯·æ±‚
    final requestData = _buildRequestData(base64Image);
    
    // 4. å‘é€è¯·æ±‚ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
    final response = await _sendRequest(requestData);
    
    // 5. è§£æå“åº”
    if (response.data == null) {
      return ApiResponse.error('APIå“åº”ä¸ºç©º');
    }
    final analysis = _parseResponse(response.data!);
    
    return ApiResponse.success(analysis, rawResponse: response.data);
    
  } on DioException catch (e) {
    return _handleDioError(e);
  } catch (e) {
    return ApiResponse.error('è¯†åˆ«å¤±è´¥: ${e.toString()}');
  }
}
```

#### 3.3 å›¾ç‰‡è½¬ Base64

```dart
Future<String?> _imageToBase64(String imagePath) async {
  try {
    final file = File(imagePath);
    final bytes = await file.readAsBytes();
    final base64 = base64Encode(bytes);
    return 'data:image/jpeg;base64,$base64';
  } catch (e) {
    debugPrint('å›¾ç‰‡è½¬æ¢å¤±è´¥: $e');
    return null;
  }
}
```

#### 3.4 æ„å»º API è¯·æ±‚

**ä½ç½®**: [`lib/services/api_service.dart:115-168`](file:///Users/zhb/code/food/lib/services/api_service.dart#L115-L168)

```dart
Map<String, dynamic> _buildRequestData(String base64Image) {
  // å®šä¹‰ Promptï¼ˆæŒ‰ç…§ PRD è¦æ±‚ï¼‰
  final prompt = '''
è¯·ä»”ç»†åˆ†æè¿™å¼ å›¾ç‰‡ä¸­çš„é£Ÿç‰©ï¼Œå¹¶è¿”å›JSONæ ¼å¼çš„åˆ†æç»“æœã€‚

è¦æ±‚ï¼š
1. è¯†åˆ«å›¾ç‰‡ä¸­çš„ä¸»è¦é£Ÿç‰©åç§°
2. åˆ—å‡ºé£Ÿç‰©çš„ä¸»è¦æˆåˆ†
3. ä¼°ç®—æ€»çƒ­é‡ï¼ˆåƒå¡ï¼‰
4. ä¼°ç®—é£Ÿç‰©é‡é‡ï¼ˆå…‹ï¼‰
5. æ ¹æ®é£Ÿç‰©ç±»å‹åˆ¤æ–­é¤æ¬¡ï¼ˆbreakfast/lunch/dinner/otherï¼‰
6. æä¾›è¥å…»ä¿¡æ¯ç®€è¿°
7. ç»™å‡ºè¯†åˆ«ç½®ä¿¡åº¦ï¼ˆ0-1ä¹‹é—´çš„å°æ•°ï¼‰

è¿”å›æ ¼å¼ï¼š
{
  "food_name": "å…·ä½“çš„é£Ÿç‰©åç§°",
  "ingredients": ["ä¸»è¦æˆåˆ†1", "ä¸»è¦æˆåˆ†2", "ä¸»è¦æˆåˆ†3"],
  "calories": ä¼°ç®—çš„çƒ­é‡æ•°å€¼ï¼ˆæ•´æ•°ï¼‰,
  "weight": ä¼°ç®—çš„é‡é‡ï¼ˆæ•°å€¼ï¼‰,
  "meal_type": "é¤æ¬¡ç±»å‹",
  "nutrition_info": "è¥å…»ä¿¡æ¯ç®€è¿°",
  "confidence": è¯†åˆ«ç½®ä¿¡åº¦ï¼ˆ0.0-1.0ï¼‰,
  "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2", "æ ‡ç­¾3"]
}

æ³¨æ„ï¼š
- çƒ­é‡è¦åŸºäºå¸¸è§çš„è¥å…»æ ‡å‡†ä¼°ç®—
- é‡é‡è¦è€ƒè™‘é£Ÿç‰©çš„å®é™…åˆ†é‡
- åªè¿”å›JSONæ ¼å¼çš„æ•°æ®ï¼Œä¸è¦åŒ…å«å…¶ä»–æ–‡å­—
''';
  
  // æ„å»ºç¬¦åˆè±†åŒ… API æ ¼å¼çš„è¯·æ±‚
  return {
    'model': _model,
    'messages': [
      {
        'role': 'user',
        'content': [
          {
            'type': 'image_url',
            'image_url': {
              'url': base64Image,  // Base64 ç¼–ç çš„å›¾ç‰‡
            },
          },
          {
            'type': 'text',
            'text': prompt,  // è¯†åˆ«æŒ‡ä»¤
          },
        ],
      },
    ],
    'max_tokens': 1000,
    'temperature': 0.1,  // ä½æ¸©åº¦ä»¥è·å¾—æ›´ç¡®å®šæ€§çš„ç»“æœ
  };
}
```

#### 3.5 å‘é€è¯·æ±‚ï¼ˆå¸¦é‡è¯•ï¼‰

**ä½ç½®**: [`lib/services/api_service.dart:171-204`](file:///Users/zhb/code/food/lib/services/api_service.dart#L171-L204)

```dart
Future<Response<Map<String, dynamic>>> _sendRequest(
  Map<String, dynamic> data
) async {
  int retryCount = 0;
  DioException? lastError;
  
  while (retryCount < _maxRetries) {
    try {
      debugPrint('å‘é€APIè¯·æ±‚ (å°è¯• ${retryCount + 1}/$_maxRetries)');
      
      final response = await _dio.post<Map<String, dynamic>>(
        '/chat/completions',  // è±†åŒ… API ç«¯ç‚¹
        data: data,
      );
      
      debugPrint('APIå“åº”æˆåŠŸ: ${response.statusCode}');
      return response;
      
    } on DioException catch (e) {
      lastError = e;
      retryCount++;
      
      // ç½‘ç»œé”™è¯¯ä¸”è¿˜æœ‰é‡è¯•æœºä¼šï¼Œåˆ™ç­‰å¾…åé‡è¯•
      if (_shouldRetry(e) && retryCount < _maxRetries) {
        debugPrint('APIè¯·æ±‚å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•...');
        await Future.delayed(Duration(seconds: 2 * retryCount));
        continue;
      }
      
      rethrow;
    }
  }
  
  throw lastError!;
}
```

#### 3.6 è§£æ API å“åº”

**ä½ç½®**: [`lib/services/api_service.dart:223-269`](file:///Users/zhb/code/food/lib/services/api_service.dart#L223-L269)

```dart
FoodAnalysis _parseResponse(Map<String, dynamic> responseData) {
  try {
    // 1. è·å–å›å¤å†…å®¹
    final choices = responseData['choices'] as List<dynamic>?;
    if (choices == null || choices.isEmpty) {
      throw Exception('APIå“åº”æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘choiceså­—æ®µ');
    }
    
    final firstChoice = choices.first as Map<String, dynamic>;
    final message = firstChoice['message'] as Map<String, dynamic>?;
    if (message == null) {
      throw Exception('APIå“åº”æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘messageå­—æ®µ');
    }
    
    final content = message['content'] as String?;
    if (content == null || content.isEmpty) {
      throw Exception('APIå“åº”å†…å®¹ä¸ºç©º');
    }
    
    debugPrint('APIå›å¤å†…å®¹: $content');
    
    // 2. è§£æ JSON
    Map<String, dynamic> jsonData;
    try {
      // æå– JSON éƒ¨åˆ†ï¼ˆå¤„ç†å¯èƒ½çš„å‰åç¼€æ–‡æœ¬ï¼‰
      final jsonStr = _extractJsonFromContent(content);
      jsonData = json.decode(jsonStr) as Map<String, dynamic>;
    } catch (e) {
      debugPrint('JSONè§£æå¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨è§£æ: $e');
      jsonData = _parseManualContent(content);
    }
    
    // 3. è½¬æ¢ä¸º FoodAnalysis å¯¹è±¡
    return FoodAnalysis.fromMap(jsonData);
    
  } catch (e) {
    debugPrint('è§£æå“åº”å¤±è´¥: $e');
    
    // è¿”å›é»˜è®¤åˆ†æç»“æœ
    return FoodAnalysis(
      foodName: 'æœªè¯†åˆ«é£Ÿç‰©',
      ingredients: [],
      calories: 0,
      confidence: 0.0,
      nutritionInfo: 'æ— æ³•è¯†åˆ«é£Ÿç‰©ï¼Œè¯·é‡æ–°æ‹ç…§',
    );
  }
}
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹

### FoodAnalysis (API å“åº”æ¨¡å‹)

```dart
class FoodAnalysis {
  final String foodName;           // é£Ÿç‰©åç§°
  final List<String> ingredients;  // ä¸»è¦æˆåˆ†
  final int calories;              // æ€»çƒ­é‡ï¼ˆåƒå¡ï¼‰
  final double weight;             // é‡é‡ï¼ˆå…‹ï¼‰
  final String mealType;           // é¤æ¬¡ç±»å‹
  final String nutritionInfo;      // è¥å…»ä¿¡æ¯
  final double confidence;         // è¯†åˆ«ç½®ä¿¡åº¦
  final List<String> tags;         // æ ‡ç­¾
}
```

### ApiResponse (ç»Ÿä¸€å“åº”åŒ…è£…)

```dart
class ApiResponse {
  final bool success;              // æ˜¯å¦æˆåŠŸ
  final String message;            // æ¶ˆæ¯
  final FoodAnalysis? data;        // è¯†åˆ«ç»“æœ
  final dynamic rawResponse;       // åŸå§‹å“åº”
  final int? statusCode;           // HTTP çŠ¶æ€ç 
}
```

---

## ğŸ”§ å…³é”®é…ç½®

### è±†åŒ… API é…ç½®ï¼ˆæ¥è‡ª PRDï¼‰

- **API Key**: `405fe7f2-f603-4c4c-b04b-bdea5d441319`
- **ç«¯ç‚¹**: `https://ark.cn-beijing.volces.com/api/v3/chat/completions`
- **æ¨¡å‹**: `doubao-seed-1-6-vision-250815`
- **æ–‡æ¡£**: https://console.volcengine.com/ark/region:ark+cn-beijing/endpoint/detail?Id=ep-20251112223504-j8pvh&Tab=api

### è¯·æ±‚é™åˆ¶

- **æœ€å¤§æ–‡ä»¶å¤§å°**: 10MB
- **è¶…æ—¶æ—¶é—´**: 30ç§’
- **æœ€å¤§é‡è¯•æ¬¡æ•°**: 3æ¬¡
- **é‡è¯•ç­–ç•¥**: æŒ‡æ•°é€€é¿ï¼ˆ2ç§’ Ã— é‡è¯•æ¬¡æ•°ï¼‰

---

## âš ï¸ é”™è¯¯å¤„ç†

### 1. ç½‘ç»œé”™è¯¯
- è¿æ¥è¶…æ—¶
- å‘é€è¶…æ—¶
- æ¥æ”¶è¶…æ—¶
- è¿æ¥é”™è¯¯

**å¤„ç†**: è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰

### 2. HTTP é”™è¯¯
- 400: è¯·æ±‚å‚æ•°é”™è¯¯
- 401: APIå¯†é’¥æ— æ•ˆ
- 403: è®¿é—®è¢«æ‹’ç»
- 429: è¯·æ±‚è¿‡äºé¢‘ç¹
- 500+: æœåŠ¡å™¨é”™è¯¯

**å¤„ç†**: è¿”å›å‹å¥½é”™è¯¯æ¶ˆæ¯

### 3. æ•°æ®é”™è¯¯
- å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨
- å›¾ç‰‡æ ¼å¼ä¸æ”¯æŒ
- å›¾ç‰‡æ–‡ä»¶è¿‡å¤§
- JSON è§£æå¤±è´¥

**å¤„ç†**: å›é€€åˆ°é»˜è®¤å€¼æˆ–æ‰‹åŠ¨è§£æ

---

## ğŸ¯ ä¼˜åŒ–ç‚¹

1. **çƒ­é‡éªŒè¯**: å¦‚æœ API è¿”å›çš„çƒ­é‡è¿‡ä½ï¼ˆ< 20åƒå¡ï¼‰ï¼Œä½¿ç”¨æœ¬åœ°çƒ­é‡è®¡ç®—å™¨é‡æ–°ä¼°ç®—
2. **ç½®ä¿¡åº¦è°ƒæ•´**: å¦‚æœçƒ­é‡è°ƒæ•´å¹…åº¦å¤§ï¼Œç›¸åº”é™ä½ç½®ä¿¡åº¦
3. **é¤æ¬¡è°ƒæ•´**: æ ¹æ®é¤æ¬¡ç±»å‹å¯¹çƒ­é‡è¿›è¡Œå¾®è°ƒ
4. **ç¼“å­˜æœºåˆ¶**: å¯ä»¥æ·»åŠ å›¾ç‰‡ hash ç¼“å­˜ï¼Œé¿å…é‡å¤è¯†åˆ«ç›¸åŒå›¾ç‰‡
5. **ç¦»çº¿æ”¯æŒ**: å¯ä»¥æ·»åŠ æœ¬åœ°æ¨¡å‹ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

```dart
// åœ¨ UI å±‚è°ƒç”¨
final foodProvider = Provider.of<FoodProvider>(context, listen: false);

// è¯†åˆ«å›¾ç‰‡
final response = await foodProvider.recognizeFoodFromImage('/path/to/image.jpg');

if (response.success && response.data != null) {
  final analysis = response.data!;
  print('é£Ÿç‰©åç§°: ${analysis.foodName}');
  print('æ€»çƒ­é‡: ${analysis.calories} åƒå¡');
  print('ç½®ä¿¡åº¦: ${(analysis.confidence * 100).toStringAsFixed(1)}%');
  
  // ä¿å­˜åˆ°æ•°æ®åº“
  await foodProvider.saveFoodRecord(
    foodName: analysis.foodName,
    ingredients: analysis.ingredients,
    calories: analysis.calories,
    imagePath: imagePath,
    mealType: analysis.mealType,
    // ...
  );
} else {
  print('è¯†åˆ«å¤±è´¥: ${response.message}');
}
```
